<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Defect List Uygulaması</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f4f4f9;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    .input-container, .table-container {
      margin-bottom: 20px;
    }
    input, button {
      margin: 10px;
      padding: 12px 18px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    input:focus, button:focus {
      outline: none;
      border-color: #007BFF;
    }
    .input-container input {
      width: 200px;
    }
    button {
      background-color: #007BFF;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    table, th, td {
      border: 1px solid #ddd;
    }
    th, td {
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f0f0f0;
    }
    .image-cell img {
      width: 50px;
      height: auto;
    }
  </style>
</head>
<body>

  <h1>Defect List Uygulaması</h1>

  <div class="input-container">
    <input type="text" id="defect" placeholder="Arıza" />
    <input type="text" id="location" placeholder="Arıza Lokasyonu" />
    <input type="text" id="note" placeholder="Not" />
    <input type="text" id="pn" placeholder="P/N" />
    <button id="addRecord">Ekle</button>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Arıza</th>
          <th>Arıza Lokasyonu</th>
          <th>Not</th>
          <th>P/N</th>
          <th>Resim</th>
        </tr>
      </thead>
      <tbody id="defectTableBody"></tbody>
    </table>
  </div>

  <button id="downloadPDF">PDF Olarak İndir</button>
  <button id="downloadXLSX">XLSX Olarak İndir</button>

  <div id="cameraModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); justify-content: center; align-items: center;">
    <video id="cameraView" autoplay playsinline style="width: 80%; max-width: 500px;"></video>
    <button id="capture">Fotoğraf Çek</button>
    <button id="closeCamera">Kapat</button>
    <canvas id="canvas" style="display: none;"></canvas>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

  <script>
    const defectInput = document.getElementById("defect");
    const locationInput = document.getElementById("location");
    const noteInput = document.getElementById("note");
    const pnInput = document.getElementById("pn");
    const addRecordButton = document.getElementById("addRecord");
    const defectTableBody = document.getElementById("defectTableBody");
    const cameraModal = document.getElementById("cameraModal");
    const cameraView = document.getElementById("cameraView");
    const captureButton = document.getElementById("capture");
    const closeCameraButton = document.getElementById("closeCamera");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    let currentImageCell = null;
    const records = [];

    // Tabloya yeni kayıt ekleme
    addRecordButton.addEventListener("click", () => {
      const defect = defectInput.value.trim();
      const location = locationInput.value.trim();
      const note = noteInput.value.trim();
      const pn = pnInput.value.trim();

      if (!defect || !location || !note || !pn) {
        alert("Lütfen tüm alanları doldurun!");
        return;
      }

      // Yeni satır oluştur
      const row = document.createElement("tr");

      // Veriler için hücreler ekle
      row.innerHTML = `
        <td>${defect}</td>
        <td>${location}</td>
        <td>${note}</td>
        <td>${pn}</td>
        <td class="image-cell"><button class="addImage">Resim Ekle</button></td>
      `;
      defectTableBody.appendChild(row);

      records.push({ defect, location, note, pn, image: null });

      // Resim ekleme butonu için olay
      row.querySelector(".addImage").addEventListener("click", (e) => {
        currentImageCell = e.target.parentElement;
        openCamera();
      });

      // Alanları temizle
      defectInput.value = "";
      locationInput.value = "";
      noteInput.value = "";
      pnInput.value = "";
    });

    // Kamera modalını aç
    function openCamera() {
      cameraModal.style.display = "flex";
      // Arka kameraya erişim sağla
      navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: "environment" } // Arka kamerayı seçiyoruz
      })
        .then((stream) => {
          cameraView.srcObject = stream;
        })
        .catch((error) => {
          console.error("Kameraya erişim sağlanamadı:", error);
          closeCamera();
        });
    }

    // Kamera modalını kapat
    function closeCamera() {
      cameraModal.style.display = "none";
      const stream = cameraView.srcObject;
      if (stream) {
        stream.getTracks().forEach((track) => track.stop());
      }
      cameraView.srcObject = null;
    }

    closeCameraButton.addEventListener("click", closeCamera);

    // Fotoğraf çek
    captureButton.addEventListener("click", () => {
      canvas.width = cameraView.videoWidth;
      canvas.height = cameraView.videoHeight;
      ctx.drawImage(cameraView, 0, 0, canvas.width, canvas.height);
      const imageData = canvas.toDataURL("image/png");

      // Resmi tabloya ekle
      if (currentImageCell) {
        currentImageCell.innerHTML = `<img src="${imageData}" alt="Resim" style="width: 50px; height: auto;" />`;
        const recordIndex = Array.from(defectTableBody.children).indexOf(currentImageCell.parentElement);
        records[recordIndex].image = imageData;
      }

      closeCamera();
    });

    // PDF çıktısı almak için
    document.getElementById("downloadPDF").addEventListener("click", () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 20;
      
      doc.text("Defect Listesi", 14, y);
      y += 10;

      records.forEach(record => {
        doc.text(`Arıza: ${record.defect}`, 14, y);
        doc.text(`Lokasyon: ${record.location}`, 14, y + 10);
        doc.text(`Not: ${record.note}`, 14, y + 20);
        doc.text(`P/N: ${record.pn}`, 14, y + 30);

        if (record.image) {
          doc.addImage(record.image, "PNG", 14, y + 40, 50, 50);
          y += 60; // Resim ekledikçe y'yi artır
        }

        y += 70; // Sonraki kayda geç
      });

      doc.save("defect-list.pdf");
    });

    // XLSX çıktısı almak için
    document.getElementById("downloadXLSX").addEventListener("click", () => {
      const ws_data = records.map(record => [
        record.defect,
        record.location,
        record.note,
        record.pn,
        record.image || ''
      ]);

      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Defect Listesi");

      XLSX.writeFile(wb, "defect-list.xlsx");
    });
  </script>

</body>
</html>
