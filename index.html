<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Defect List</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f4f4f9;
    }
    h1 {
      text-align: center;
    }
    .input-container, .table-container {
      margin-bottom: 20px;
    }
    input, button {
      margin: 10px;
      padding: 12px 18px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    input:focus, button:focus {
      outline: none;
      border-color: #007BFF;
    }
    .input-container input {
      width: 200px;
    }
    button {
      background-color: #007BFF;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    table, th, td {
      border: 1px solid #ddd;
    }
    th, td {
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f0f0f0;
    }
    .image-cell img {
      width: 50px;
      height: auto;
    }
  </style>
</head>
<body>

  <h1>Defect List Uygulaması</h1>

  <div class="input-container">
    <input type="text" id="ac" placeholder="A/C" />
    <input type="text" id="defect" placeholder="Arıza" />
    <input type="text" id="location" placeholder="Arıza Lokasyonu" />
    <input type="text" id="note" placeholder="Not" />
    <input type="text" id="pn" placeholder="P/N" />
    <button id="addRecord">Ekle</button>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>A/C</th>
          <th>Arıza</th>
          <th>Arıza Lokasyonu</th>
          <th>Not</th>
          <th>P/N</th>
          <th>Resim</th>
        </tr>
      </thead>
      <tbody id="defectTableBody"></tbody>
    </table>
  </div>

  <button id="downloadPDF">PDF Olarak İndir</button>
  <button id="downloadXLSX">XLSX Olarak İndir</button>

  <div id="cameraModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); justify-content: center; align-items: center;">
    <video id="cameraView" autoplay playsinline style="width: 80%; max-width: 500px;"></video>
    <button id="capture">Fotoğraf Çek</button>
    <button id="closeCamera">Kapat</button>
    <canvas id="canvas" style="display: none;"></canvas>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

  <script>
    const defectInput = document.getElementById("defect");
    const acInput = document.getElementById("ac");
    const locationInput = document.getElementById("location");
    const noteInput = document.getElementById("note");
    const pnInput = document.getElementById("pn");
    const addRecordButton = document.getElementById("addRecord");
    const defectTableBody = document.getElementById("defectTableBody");
    const cameraModal = document.getElementById("cameraModal");
    const cameraView = document.getElementById("cameraView");
    const captureButton = document.getElementById("capture");
    const closeCameraButton = document.getElementById("closeCamera");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    let currentImageCell = null;
    const records = [];

    // Google Sheets bağlantısı ve veri kaydetme fonksiyonu
    const SHEET_ID = '15-w5cSmMSq5vSon3PDpB0PYdAQxvQRpLfk14Tt54gs8';
    const API_KEY = 'AIzaSyDltb5FbPvL9bLgj_GK4_DEDaPK0A7oM_g';
    const CLIENT_ID = '347723096847-kts8cmj7v8hq6drrfk3n0n8qcdrc7j8i.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

    gapi.load('client:auth2', initClient);

    function initClient() {
      gapi.client.init({
        apiKey: API_KEY,
        clientId: CLIENT_ID,
        scope: SCOPES,
        discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
      }).then(() => {
        console.log('GAPI client loaded');
      });
    }

    // Tabloya yeni kayıt ekleme
    addRecordButton.addEventListener("click", () => {
      const ac = acInput.value.trim();
      const defect = defectInput.value.trim();
      const location = locationInput.value.trim();
      const note = noteInput.value.trim();
      const pn = pnInput.value.trim();

      if (!ac || !defect || !location || !note || !pn) {
        alert("Lütfen tüm alanları doldurun!");
        return;
      }

      // Google Sheets'e kaydetme
      gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: SHEET_ID,
        range: 'Sheet1!A:F',
        valueInputOption: 'RAW',
        resource: {
          values: [[ac, defect, location, note, pn, '']]
        }
      }).then((response) => {
        console.log('Data saved to Google Sheets');
      });

      // Yeni satır oluştur
      const row = document.createElement("tr");

      // Veriler için hücreler ekle
      row.innerHTML = `
        <td>${ac}</td>
        <td>${defect}</td>
        <td>${location}</td>
        <td>${note}</td>
        <td>${pn}</td>
        <td class="image-cell"><button class="addImage">Resim Ekle</button></td>
      `;
      defectTableBody.appendChild(row);

      records.push({ ac, defect, location, note, pn, image: null });

      // Resim ekleme butonu için olay
      row.querySelector(".addImage").addEventListener("click", (e) => {
        currentImageCell = e.target.parentElement;
        openCamera();
      });

      // Alanları temizle
      acInput.value = "";
      defectInput.value = "";
      locationInput.value = "";
      noteInput.value = "";
      pnInput.value = "";
    });

    // Kamera modalını aç
    function openCamera() {
      cameraModal.style.display = "flex";
      // Arka kameraya erişim sağla
      navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: "environment" } 
      }).then((stream) => {
        cameraView.srcObject = stream;
      });
    }

    // Fotoğraf çek
    captureButton.addEventListener("click", () => {
      const videoWidth = cameraView.videoWidth;
      const videoHeight = cameraView.videoHeight;
      canvas.width = videoWidth;
      canvas.height = videoHeight;
      ctx.drawImage(cameraView, 0, 0, videoWidth, videoHeight);
      const imageData = canvas.toDataURL("image/png");
      
      // Resmi hücreye ekle
      currentImageCell.innerHTML = `<img src="${imageData}" alt="Defect Image" />`;
      records.find(record => record.ac === acInput.value.trim()).image = imageData;

      closeCamera();
    });

    // Kamera modalını kapat
    closeCameraButton.addEventListener("click", () => {
      closeCamera();
    });

    function closeCamera() {
      cameraModal.style.display = "none";
      cameraView.srcObject.getTracks().forEach(track => track.stop());
    }

    // PDF indirme
    document.getElementById("downloadPDF").addEventListener("click", () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 10;

      records.forEach(record => {
        doc.text(`A/C: ${record.ac}`, 10, y);
        doc.text(`Arıza: ${record.defect}`, 10, y + 10);
        doc.text(`Lokasyon: ${record.location}`, 10, y + 20);
        doc.text(`Not: ${record.note}`, 10, y + 30);
        doc.text(`P/N: ${record.pn}`, 10, y + 40);

        if (record.image) {
          doc.addImage(record.image, "PNG", 10, y + 50, 50, 50);
          y += 60;
        }

        y += 70; // Sonraki kayda geç
      });

      doc.save("defect-list.pdf");
    });

    // XLSX indirme
    document.getElementById("downloadXLSX").addEventListener("click", () => {
      const ws_data = records.map(record => [
        record.ac,
        record.defect,
        record.location,
        record.note,
        record.pn,
        record.image || ''
      ]);

      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Defect Listesi");

      XLSX.writeFile(wb, "defect-list.xlsx");
    });
  </script>
</body>
</html>
